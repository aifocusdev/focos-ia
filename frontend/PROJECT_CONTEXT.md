# üöÄ ApiCeChat Frontend - Contexto de Desenvolvimento

## üìã **Vis√£o Geral do Projeto**

Sistema de chat/CRM para **agentes de atendimento** integrado com a API NestJS ApiCeChat. Interface web moderna para gerenciar conversas do WhatsApp Business API em tempo real.

### **Stack T√©cnico**
- **Frontend**: React 19 + TypeScript + Vite
- **Styling**: TailwindCSS + Headless UI + Heroicons
- **Estado**: Zustand (planejado)
- **API**: Axios + JWT Auth
- **WebSocket**: Socket.io Client
- **Forms**: React Hook Form + Yup
- **Roteamento**: React Router DOM

## üó∫Ô∏è **Arquitetura da API Backend**

### **Entidades Principais**
```typescript
// User
{
  id: number, name: string, username: string, 
  role_id: number, online: boolean, role: Role
}

// Conversation  
{
  id: number, contact_id: number, integration_id: number,
  assigned_user: number | null, assigned_bot: number | null,
  status: 'queue' | 'active' | 'closed' | 'transferred'
}

// Message
{
  id: number, conversation_id: number, 
  sender_type: 'contact' | 'user' | 'bot' | 'system',
  body: string, created_at: string, attachments: MessageAttachment[]
}

// Contact
{
  id: number, external_id: string, name: string, 
  phone_number: string, tags: Tag[]
}
```

### **Endpoints Principais**
```bash
# Auth
POST /auth/login        # { username, password } -> { access_token, user }
POST /auth/logout

# Conversations
GET /conversations                     # Lista com filtros (status, assigned_user, etc.)
GET /conversations/:id                 # Detalhes da conversa
PATCH /conversations/:id/assign        # Atribuir a usu√°rio/bot
PATCH /conversations/:id/close         # Fechar conversa

# Messages  
GET /messages/conversation/:id         # Mensagens da conversa (pagina√ß√£o)
GET /messages/conversation/:id/cursor  # Cursor pagination
POST /messages                         # Enviar mensagem
PATCH /messages/mark-as-read          # Marcar como lidas
GET /messages/unread-count            # Contagem n√£o lidas

# WebSocket Events (/crm namespace)
- message:new, message:read, message:typing
- conversation:assigned, conversation:status_changed  
- user:online, user:offline, user:typing
- join:conversation, leave:conversation
```

## üéØ **Status Atual do Desenvolvimento**

### ‚úÖ **FASE 1 CONCLU√çDA** - Setup & Autentica√ß√£o

#### **Arquivos Implementados:**

**üîê Autentica√ß√£o & Contextos**
- `src/contexts/AuthContext.tsx` - Context React com login/logout
- `src/components/auth/ProtectedRoute.tsx` - Prote√ß√£o de rotas

**üåê Services & API**
- `src/services/api.service.ts` - HTTP client Axios com interceptors
- `src/services/auth.service.ts` - Autentica√ß√£o JWT
- `src/services/conversation.service.ts` - CRUD conversas
- `src/services/message.service.ts` - CRUD mensagens
- `src/services/websocket.service.ts` - Socket.io client com events

**üìù Types TypeScript**
- `src/types/user.types.ts` - User, Role, LoginRequest/Response
- `src/types/conversation.types.ts` - Conversation, ConversationStatus, etc.
- `src/types/message.types.ts` - Message, MessageAttachment, etc.
- `src/types/contact.types.ts` - Contact + CRUD DTOs
- `src/types/tag.types.ts` - Tag + CRUD DTOs  
- `src/types/bot.types.ts` - Bot + CRUD DTOs

**üé® UI Components & Layout**
- `src/components/ui/LoadingSpinner.tsx` - Spinner reutiliz√°vel
- `src/components/layout/DashboardLayout.tsx` - Layout principal
- `src/pages/LoginPage.tsx` - P√°gina de login completa
- `src/pages/DashboardPage.tsx` - Dashboard (placeholder)
- `src/utils/cn.ts` - Utility para classes CSS

**‚öôÔ∏è Configura√ß√µes**
- `tailwind.config.js` - Config customizada com cores/anima√ß√µes
- `src/index.css` - Classes CSS customizadas
- `.env` - Vari√°veis ambiente (VITE_API_URL=http://localhost:3000)

#### **Funcionalidades Implementadas:**
‚úÖ Sistema de autentica√ß√£o JWT funcional  
‚úÖ Interceptors Axios para tokens/erros  
‚úÖ WebSocket service com auto-reconnect  
‚úÖ Layout responsivo 3-pain√©is  
‚úÖ Design system TailwindCSS  
‚úÖ Types completos da API  
‚úÖ Build sem erros ‚úÖ  
‚úÖ Dev server funcional (port 5174)  

### üîÑ **FASE 2 EM ANDAMENTO** - Estado Global & WebSocket

#### **Pr√≥ximas Implementa√ß√µes:**
```typescript
// Stores Zustand a criar:
- authStore      // usu√°rio logado, status online
- conversationStore // lista conversas, filtros, selecionada  
- messageStore   // mensagens por conversa, typing
- uiStore        // loading, modais, notifica√ß√µes
```

#### **Tasks Pendentes:**
- [ ] Criar Zustand stores (auth, conversations, messages, ui)
- [ ] Configurar WebSocket listeners nos stores
- [ ] Sistema de notifica√ß√µes toast
- [ ] Hooks customizados (useConversations, useMessages, etc.)

## üõ†Ô∏è **Comandos de Desenvolvimento**

```bash
# Setup
npm install                     # Instalar depend√™ncias
cp .env.example .env           # Configurar environment

# Development  
npm run dev                    # Dev server (porta 5174)
npm run build                  # Build produ√ß√£o
npm run preview               # Preview build
npm run lint                  # ESLint

# API Backend (separado)
cd ../apicechat-api
pnpm run start:dev            # API em localhost:3000
```

## üé® **Design System**

### **Classes CSS Customizadas**
```css
/* Buttons */
.btn-primary    /* Azul prim√°rio */
.btn-secondary  /* Cinza */  
.btn-success    /* Verde */
.btn-danger     /* Vermelho */
.btn-outline    /* Outline */

/* Status Badges */
.status-queue       /* Amarelo - na fila */
.status-active      /* Verde - ativa */
.status-closed      /* Cinza - fechada */
.status-transferred /* Azul - transferida */

/* Inputs */
.input         /* Input padr√£o */
.input-error   /* Input com erro */

/* Layout */
.card          /* Card branco com sombra */
.scrollbar-thin /* Scrollbar customizada */
```

### **Cores do Theme**
```javascript
primary: { 500: '#3b82f6', 600: '#2563eb' }  // Azul
success: { 500: '#22c55e', 600: '#16a34a' }  // Verde  
warning: { 500: '#f59e0b', 600: '#d97706' }  // Amarelo
danger:  { 500: '#ef4444', 600: '#dc2626' }  // Vermelho
```

## üì± **Interface Planejada**

### **Layout Dashboard (3 pain√©is)**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CONVERSAS     ‚îÇ      CHAT        ‚îÇ    DETALHES    ‚îÇ
‚îÇ                 ‚îÇ                  ‚îÇ                ‚îÇ
‚îÇ - Filtros       ‚îÇ - Cabe√ßalho      ‚îÇ - Info Contato ‚îÇ
‚îÇ - Lista         ‚îÇ - Mensagens      ‚îÇ - Tags         ‚îÇ
‚îÇ - Busca         ‚îÇ - Input          ‚îÇ - Hist√≥rico    ‚îÇ
‚îÇ - Status        ‚îÇ - Anexos         ‚îÇ - A√ß√µes        ‚îÇ
‚îÇ                 ‚îÇ                  ‚îÇ                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Funcionalidades por Painel**

**Painel Esquerdo - Lista Conversas:**
- [x] Scroll infinito
- [x] Filtros (status, atribui√ß√£o)
- [x] Busca por contato/telefone
- [x] Badges mensagens n√£o lidas
- [x] Status visual (queue/active/closed)

**Painel Central - Chat:**
- [x] Lista mensagens com scroll
- [x] Tipos: texto, m√≠dia, sistema
- [x] Status entrega (enviado/lido)
- [x] Input com anexos
- [x] Indicador "digitando"

**Painel Direito - Detalhes:**
- [x] Dados do contato
- [x] Tags edit√°veis  
- [x] A√ß√µes (atribuir, fechar)
- [x] Hist√≥rico conversas

## üîÑ **Fluxos de Dados**

### **Autentica√ß√£o**
1. Login ‚Üí AuthService.login() ‚Üí JWT token ‚Üí localStorage
2. AuthContext ‚Üí user state ‚Üí ProtectedRoute
3. Axios interceptors ‚Üí Authorization header
4. Token expired ‚Üí redirect /login

### **Conversas (Planejado)**
1. ConversationStore.fetch() ‚Üí API ‚Üí lista conversas
2. WebSocket ‚Üí conversation:updated ‚Üí store.update()  
3. User seleciona ‚Üí store.setSelected() ‚Üí fetch messages
4. Atribuir conversa ‚Üí API ‚Üí WebSocket broadcast

### **Mensagens (Planejado)**  
1. MessageStore.fetchByConversation() ‚Üí cursor pagination
2. WebSocket ‚Üí message:new ‚Üí store.addMessage()
3. Enviar mensagem ‚Üí API ‚Üí WebSocket ‚Üí store update
4. Typing indicators ‚Üí WebSocket events

### **Real-time Events**
```typescript
// WebSocket listeners necess√°rios:
websocket.on('message:new', (data) => messageStore.addMessage(data))
websocket.on('conversation:assigned', (data) => conversationStore.update(data))  
websocket.on('user:typing', (data) => messageStore.setTyping(data))
websocket.on('user:online', (data) => authStore.updatePresence(data))
```

## üéØ **Pr√≥ximos Passos**

### **Fase 2 - Estado & WebSocket** (2-3 dias)
1. **Zustand Stores**: Implementar stores para auth, conversations, messages, ui
2. **WebSocket Integration**: Conectar events aos stores  
3. **Notification System**: Toast notifications
4. **Custom Hooks**: useConversations, useMessages, useAuth

### **Fase 3 - Interface Principal** (3-4 dias)
1. **ConversationList**: Lista conversas com filtros/busca
2. **ChatArea**: Interface de mensagens  
3. **ContactPanel**: Detalhes e a√ß√µes
4. **MessageInput**: Composi√ß√£o mensagens + anexos

### **Fase 4 - Features Avan√ßadas** (2-3 dias)
1. **Search**: Busca avan√ßada mensagens
2. **Media Viewer**: Visualizador m√≠dia
3. **Tag Management**: CRUD tags
4. **Dashboard**: M√©tricas b√°sicas

### **Fase 5 - Polish** (1-2 dias)  
1. **Performance**: Memoiza√ß√£o, lazy loading
2. **Responsive**: Mobile optimization
3. **Accessibility**: A11y
4. **Testing**: Testes essenciais

## üíæ **Estado Atual dos Dados**

### **localStorage Keys**
- `accessToken` - JWT token autentica√ß√£o
- `currentUser` - Dados usu√°rio logado (temp solution)

### **API Configuration**
- Base URL: `http://localhost:3000` 
- WebSocket: `/crm` namespace
- Timeout: 10s
- Auto token refresh: ‚ùå (implementar)

## üêõ **Problemas Conhecidos & Solu√ß√µes**

### **Resolvidos:**
‚úÖ Socket.io import issues ‚Üí `import ioClient from 'socket.io-client'`  
‚úÖ TypeScript verbatimModuleSyntax ‚Üí type imports  
‚úÖ erasableSyntaxOnly conflitos ‚Üí removido do tsconfig  
‚úÖ Build errors ‚Üí todos corrigidos  

### **A Implementar:**
- [ ] API /me endpoint (ou JWT decode para currentUser)
- [ ] Token refresh autom√°tico  
- [ ] Error boundaries React
- [ ] Loading states globais
- [ ] Retry logic para requests falhados

## üìÅ **Estrutura de Arquivos Atual**

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProtectedRoute.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DashboardLayout.tsx  
‚îÇ   ‚îî‚îÄ‚îÄ ui/
‚îÇ       ‚îî‚îÄ‚îÄ LoadingSpinner.tsx
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.tsx
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ DashboardPage.tsx
‚îÇ   ‚îî‚îÄ‚îÄ LoginPage.tsx
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ api.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts  
‚îÇ   ‚îú‚îÄ‚îÄ conversation.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ message.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ websocket.service.ts
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ bot.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ contact.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ conversation.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ message.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ tag.types.ts
‚îÇ   ‚îî‚îÄ‚îÄ user.types.ts
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ cn.ts
‚îú‚îÄ‚îÄ App.tsx
‚îú‚îÄ‚îÄ main.tsx
‚îî‚îÄ‚îÄ index.css
```

---

## üöÄ **Como Continuar o Desenvolvimento**

1. **Ler este arquivo** para recuperar contexto completo
2. **Verificar todo list** atual no arquivo
3. **Iniciar Fase 2** com implementa√ß√£o dos Zustand stores
4. **Testar continuamente** com `npm run dev` e `npm run build`
5. **Manter este arquivo atualizado** conforme progresso

**√öltima atualiza√ß√£o**: Fase 1 conclu√≠da com sucesso ‚úÖ